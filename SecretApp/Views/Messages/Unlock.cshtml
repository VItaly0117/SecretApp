@model Guid
<section style="display: flex; justify-content: center; padding: 2rem;">
    <div class="glass-card" style="width: 100%; max-width: 60rem;">
        <div id="lockSection">
            <h3 style="font-size: 3.2rem; margin-bottom: 2rem; font-weight: 700;">🔒 Захищено</h3>
            <p style="font-size: 1.6rem; margin-bottom: 2rem; color: #ccc;">Це повідомлення самознищиться після відкриття.</p>
            <input type="password" id="p" class="form-control" placeholder="Введіть пароль">
            <button onclick="viewSecret()" class="btn" style="width: 100%;">Відкрити</button>
        </div>

        <div id="viewSection" style="display:none;">
            <h3 style="font-size: 2.2rem; color: var(--main-color); margin-bottom: 1.5rem;">Зміст:</h3>
            <div id="content" style="background: rgba(0,0,0,0.2); padding: 2rem; border-radius: 1rem; font-size: 1.6rem; line-height: 1.6; white-space: pre-wrap;"></div>
            <p style="margin-top: 2rem; color: #ff6b6b; font-size: 1.2rem;">⚠️ Повідомлення видалено з сервера.</p>
            <a href="/" class="btn" style="margin-top: 2rem; background: var(--second-bg-color); color: white; box-shadow: none;">Закрити</a>
        </div>
    </div>
</section>

<script>
    async function viewSecret() {
        const pwd = document.getElementById('p').value;
        const res = await fetch('/Messages/GetAndDestroy/@Model', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(pwd)
        });

        if(!res.ok) return alert("Невірний пароль або посилання недійсне.");
        const data = await res.json();

        try {
            const enc = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(pwd), "PBKDF2", false, ["deriveKey"]);
            const key = await crypto.subtle.deriveKey(
                { name: "PBKDF2", salt: enc.encode("salt-123"), iterations: 100000, hash: "SHA-256" },
                keyMaterial, { name: "AES-GCM", length: 256 }, false, ["decrypt"]
            );

            const encryptedData = Uint8Array.from(atob(data.encryptedData), c => c.charCodeAt(0));
            const iv = Uint8Array.from(atob(data.iv), c => c.charCodeAt(0));
            const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, key, encryptedData);

            document.getElementById('content').innerText = new TextDecoder().decode(decrypted);
            document.getElementById('lockSection').style.display = 'none';
            document.getElementById('viewSection').style.display = 'block';
        } catch(e) {
            alert("Помилка дешифрування.");
        }
    }
</script>